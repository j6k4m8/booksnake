#!/usr/bin/python

import sys, converter, messenger, downloader, os

def main(argv):
    if '-h' in argv:
        print 'usage: booksnake [filename]'
    if len(argv) >= 1:
        if argv[0].startswith('http'):

            if '-f' in argv:
                _fmt = argv[argv.index('-f') + 1]
                filename = downloader.download_uri(argv[0], fmt=_fmt)
            else:
                print "No format given, try `-f mobi` or `-f html` or whatever."
                return
        else:
            filename = argv[0]
    else:
        return

    base_filename = '.'.join(filename.split('.')[:-1])

    # Convert if necessary
    if converter.get_file_extension(filename) != 'mobi':
        converter.convert_epub(filename)
        final_filename = base_filename + '.mobi'
    else:
        final_filename = filename

    print final_filename

    if os.path.isfile(final_filename):
        print "Sending..."
        messenger.send_file(final_filename)
    else:
        print "Conversion failed."

    if '-k' not in argv:
        os.system('rm ./.booksnake_*')

if __name__ == "__main__":
    main(sys.argv[1:])
